# Istio LLM Filter EnvoyFilter 配置示例
# 
# 本配置使用 Envoy 原生 Golang Filter API
# 参考文档: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/golang_filter
#
# 将此配置应用到 istio-system 命名空间

apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: llm-proxy-filter
  namespace: istio-system
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
    # 注入 Golang HTTP Filter
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        listener:
          filterChain:
            filter:
              name: "envoy.filters.network.http_connection_manager"
              subFilter:
                name: "envoy.filters.http.router"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.golang
          typed_config:
            # Envoy Golang Filter 配置类型
            "@type": "type.googleapis.com/envoy.extensions.filters.http.golang.v3alpha.Config"
            # 库标识符（用于 Envoy 内部缓存）
            library_id: llm-proxy
            # .so 共享库路径
            library_path: /etc/envoy/libllmproxy.so
            # 插件名称（必须与 Go 代码中注册的名称一致）
            plugin_name: llm-proxy
            # 插件配置（使用 TypedStruct 传递 JSON 配置）
            plugin_config:
              "@type": "type.googleapis.com/xds.type.v3.TypedStruct"
              value:
                # 输入协议类型
                protocol: openai
                # 负载均衡算法: inference_lb, random, round_robin
                algorithm: inference_lb
                
                # 模型路由规则
                model_mapping_rule:
                  # 模型名称 -> 路由规则
                  qwen-2.5-72b:
                    rules:
                      - scene_name: qwen-2.5-72b
                        cluster: "outbound|8000||qwen-service.llm.svc.cluster.local"
                        backend: vllm
                  
                  qwen-2.5-7b:
                    rules:
                      - scene_name: qwen-2.5-7b
                        cluster: "outbound|8000||qwen-small-service.llm.svc.cluster.local"
                        backend: vllm
                  
                  # 多路由规则示例（基于请求头匹配）
                  gpt-4:
                    rules:
                      # 生产环境路由（优先匹配，因为有 headers 条件）
                      - scene_name: gpt-4-prod
                        cluster: "outbound|8000||gpt4-prod-service.llm.svc.cluster.local"
                        backend: vllm
                        headers:
                          - key: x-env
                            value: prod
                      # 默认路由（无 headers 条件）
                      - scene_name: gpt-4-default
                        cluster: "outbound|8000||gpt4-service.llm.svc.cluster.local"
                        backend: vllm
                
                # 负载均衡配置（按模型名配置）
                lb_mapping_rule:
                  qwen-2.5-72b:
                    load_aware_enable: true      # 启用负载感知
                    cache_aware_enable: true     # 启用缓存感知
                    candidate_percent: 10        # 候选集百分比 (Top N%)
                    request_load_weight: 1       # W2: 请求队列权重
                    prefill_load_weight: 3       # W3: Prefill 队列权重
                    cache_radio_weight: 2        # W1: 缓存命中权重
                  
                  qwen-2.5-7b:
                    load_aware_enable: true
                    cache_aware_enable: false    # 小模型禁用缓存感知（KV-Cache 较小）
                    candidate_percent: 20
                    request_load_weight: 1
                    prefill_load_weight: 2
                    cache_radio_weight: 0
                  
                  gpt-4:
                    load_aware_enable: true
                    cache_aware_enable: true
                    candidate_percent: 5         # 更严格的候选筛选
                    request_load_weight: 1
                    prefill_load_weight: 3
                    cache_radio_weight: 2
